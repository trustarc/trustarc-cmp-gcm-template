___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "TrustArc CMP (Consent Mode)",
  "brand": {
    "id": "github.com_trustarc",
    "displayName": "trustarc",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Use our template to integrate TrustArc CMP with Google Tag Manager and enable Google Consent Mode on your website.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "consentManagerSettings",
    "displayName": "Consent Manager Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "deployCmpScript",
        "checkboxText": "Deploy CMP Script using the template",
        "simpleValueType": true,
        "enablingConditions": [],
        "defaultValue": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "cmpID",
            "displayName": "CMP ID",
            "simpleValueType": true,
            "help": "",
            "enablingConditions": [
              {
                "paramName": "deployCmpScript",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "additionalParameters",
            "displayName": "Additional parameters",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "deployCmpScript",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "canBeEmptyString": true
          },
          {
            "type": "SELECT",
            "name": "cmpType",
            "displayName": "CMP Version",
            "selectItems": [
              {
                "value": "pro",
                "displayValue": "CCM Pro"
              },
              {
                "value": "advanced",
                "displayValue": "CCM Advanced"
              }
            ],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "deployCmpScript",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ],
        "help": "Check this option if you would like to use this template to deploy the CMP Script."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentModeSettings",
    "displayName": "Google Consent Mode Integration",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "integrateGCM",
        "checkboxText": "Integrate CMP with Google Consent Mode",
        "simpleValueType": true,
        "defaultValue": false,
        "subParams": [
          {
            "type": "TEXT",
            "name": "impliedConsentSetting",
            "displayName": "Implied Consent Settings",
            "simpleValueType": true,
            "defaultValue": "us",
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "help": "Code of the locations that should be treated as implied (granted by default); This represents the location code present on the notice_behavior cookie. Multiple values can be separated using a comma ( , ). Include \u0027none\u0027 to add support for unprovisioned countries.",
            "valueValidators": []
          },
          {
            "type": "GROUP",
            "name": "consentTypes",
            "displayName": "Consent Types Mapping",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "LABEL",
                "name": "label1",
                "displayName": "Map each consent type below to the desired bucket ID on your CMP. As an example, if you have three buckets (Required\u003d1, Functional\u003d2 and Advertising\u003d3), you should add three to the consent types that you would like to be granted when the user opts-in to Advertising."
              },
              {
                "type": "TEXT",
                "name": "adPersonalizationId",
                "displayName": "ad_personalization",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [],
                "help": "Sets consent for personalized advertising.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "adStorageId",
                "displayName": "ad_storage",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Enables storage, such as cookies (web) or device identifiers (apps), related to advertising.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "adUserDataId",
                "displayName": "ad_user_data",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Sets consent for sending user data to Google for online advertising purposes.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "analyticsStorageId",
                "displayName": "analytics_storage",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Enables storage, such as cookies (web) or device identifiers (apps), related to analytics, for example, visit duration.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "functionalityStorageId",
                "displayName": "functionality_storage",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Enables storage that supports the functionality of the website or app, for example, language settings.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "personalizationStorageId",
                "displayName": "personalization_storage",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Enables storage related to personalization, for example, video recommendations.",
                "canBeEmptyString": true
              },
              {
                "type": "TEXT",
                "name": "securityStorageId",
                "displayName": "security_storage",
                "simpleValueType": true,
                "valueValidators": [],
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "Enables storage related to security such as authentication functionality, fraud prevention, and other user protection.",
                "canBeEmptyString": true
              }
            ],
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "help": "Map each consent type below to the desired bucket ID on your CMP. As an example, if you have three buckets (Required\u003d1, Functional\u003d2 and Advertising\u003d3), you should add three to the consent types that you would like to be granted when the user opts-in to Advertising."
          },
          {
            "type": "SELECT",
            "name": "prefCookie",
            "displayName": "Preferences Cookie",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "help": "Variable mapping the preferences cookie (cmapi_cookie_privacy)"
          },
          {
            "type": "SELECT",
            "name": "behaviorCookie",
            "displayName": "Behavior Cookie",
            "selectItems": [],
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "macrosInSelect": true,
            "help": "Variable mapping the behavior cookie (notice_behavior)"
          },
          {
            "type": "GROUP",
            "name": "settings",
            "displayName": "Additional Settings",
            "groupStyle": "ZIPPY_OPEN",
            "subParams": [
              {
                "type": "CHECKBOX",
                "name": "enableAdsRedacted",
                "checkboxText": "Redact Ads data",
                "simpleValueType": true,
                "help": "When ads_data_redaction is true and ad_storage is denied, ad click identifiers sent in network requests by Google Ads and Floodlight tags will be redacted. Network requests will also be sent through a cookieless domain."
              },
              {
                "type": "CHECKBOX",
                "name": "enableUrlPassthrough",
                "checkboxText": "Enable URL Passthrough",
                "simpleValueType": true,
                "help": "When a user lands on your website after clicking an ad, information about the ad may be appended to your landing page URLs as a query parameter. In order to improve conversion accuracy, this information is usually stored in first-party cookies on your domain.  However, if ad_storage is set to denied, this information will not be stored locally. To improve ad click measurement quality when ad_storage is denied, you can optionally elect to pass information about ad clicks through URL parameters across pages using URL passthrough.  Similarly, if analytics_storage is set to denied, URL passthrough can be used to send event and session-based analytics (including conversions) without cookies across pages.  The following conditions must be met in order to use URL passthrough:  Your Google tag is consent-aware and present on the page. The advertiser has enabled the URL passthrough feature. Consent mode is implemented on the page. The outgoing link refers to the same domain as the current page\u0027s domain. A GCLID or DCLID is present in the URL (Google Ads and Floodlight tags only)"
              },
              {
                "type": "TEXT",
                "name": "waitForUpdate",
                "displayName": "Wait for update",
                "simpleValueType": true,
                "defaultValue": 500,
                "enablingConditions": [
                  {
                    "paramName": "integrateGCM",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "help": "If your CMP loads asynchronously, it might not always run before your Google Tags. To handle such situations, specify wait_for_update along with a millisecond value to control how long to wait before data is sent.",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  },
                  {
                    "type": "NON_NEGATIVE_NUMBER"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "fireCustomEvent",
            "checkboxText": "Fire Custom Event when consent changes",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "integrateGCM",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "help": "If enabled, TrustArc will fire a custom event every time consent is loaded or changed."
          }
        ],
        "help": "Check this option if you would like to use this template to integrate with Google Consent Mode."
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableLogging",
    "checkboxText": "Enable Logging",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const callInWindow = require('callInWindow');
const gtagSet = require('gtagSet');
const injectScript = require('injectScript');
const JSON = require('JSON');
const queryPermission = require('queryPermission');
const addConsentListener = require('addConsentListener');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const copyFromWindow = require('copyFromWindow');

//Consent Mode Status
const ConsentType = {
    DENIED: 'denied',
    GRANTED: 'granted'
};

//TrustArc CMP Version
const ProductType = {
    PRO: 'pro',
    ADVANCED: 'advanced'
};

//Helper Functions
const Log = (message, extra) => {
  if (data.enableLogging) {
    message = "[TrustArc GTM Template]: " + message;
    log(message, extra || '');
  }
};
const isDefined = (s) => {
  return typeof(s) !== 'undefined' && s !== null && s.length > 0;
};

const convertBooleanToGrantedOrDenied = (boolean) => boolean ? ConsentType.GRANTED : ConsentType.DENIED;

const insertConsentState = (id, consentStates, consentTypeName, isDefault, defaultGranted, prefCookie) => {
  if (id != "" && id > -1) {
    consentStates[consentTypeName] = convertBooleanToGrantedOrDenied(isDefault ? defaultGranted : prefCookie && prefCookie.indexOf(id) > -1);
    return;
  }
   Log("No Category Mapping found for " + consentTypeName +". Skipping.");
};

const getConsentState = (prefCookie, isDefault, defaultGranted) => {
  var consentStates = {};
  insertConsentState(data.adPersonalizationId, consentStates, "ad_personalization", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.adStorageId, consentStates, "ad_storage", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.adUserDataId, consentStates, "ad_user_data", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.analyticsStorageId, consentStates, "analytics_storage", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.functionalityStorageId, consentStates, "functionality_storage", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.personalizationStorageId, consentStates, "personalization_storage", isDefault, defaultGranted, prefCookie);
  insertConsentState(data.securityStorageId, consentStates, "security_storage", isDefault, defaultGranted, prefCookie);
  return consentStates;
};

const hasGtagMapping =  (boolean) => {
  let gcm = copyFromWindow("truste.eu.bindMap.feat.gcm");
  let gtag = copyFromWindow("gtag");
  Log ("gcm: ",gcm);
  return typeof(gtag) != 'undefined' && gcm != undefined && (gcm.adPersonalization > -1 || gcm.adUserData > -1 || gcm.ads > -1 || gcm.analytics > -1 || gcm.functionality > -1 || gcm.personalization > -1 || gcm.security > -1);
};

const hostName = 'https://consent.trustarc.com';
const getCCMProScriptUrl = (cmID, product, additionalParameters) => {
    return {
        ccm: hostName+"/v2/notice/" + cmID
    };
};

const getCCMAdvancedScriptUrl = (cmID, product, additionalParameters) => {
    return {
        ccm: hostName+"/notice?domain=" + cmID + additionalParameters
    };
};

const getCCMScriptUrl = (cmID, product, additionalParameters) => {
    if (product === ProductType.PRO) return getCCMProScriptUrl(cmID, product, additionalParameters);

    return getCCMAdvancedScriptUrl(cmID, product, additionalParameters);
};

const getDefaultGranted = (behaviorCookie) => {
  const impliedConsentSetting = data.impliedConsentSetting.split(',');
  return !!(behaviorCookie && impliedConsentSetting.some(( ics => behaviorCookie.indexOf(ics) > -1)));
};

const defaultConsent = (behaviorCookie) => {
  let existingConsent = isDefined(data.prefCookie);
  if (!hasDefaultConsent && (existingConsent || isDefined(behaviorCookie))) {
    const impliedConsentSetting = data.impliedConsentSetting.split(',');
    let defaultGranted = getDefaultGranted(behaviorCookie);

    Log("Existing consent: " + existingConsent);
    Log("Implied location: " + defaultGranted);
    Log("impliedConsentSetting: " + impliedConsentSetting);
    Log("Enable unprovisioned: " + data.enableUnprovisioned);
    Log("behaviorCookie: " + behaviorCookie);
    Log("defaultGranted: " + defaultGranted);

    const consentState = getConsentState(data.prefCookie, !existingConsent, defaultGranted);

    if(data.waitForUpdate > 0){
      consentState.wait_for_update = data.waitForUpdate;
      Log(JSON.stringify(consentState));
    }

    Log("Default Consent State: " + JSON.stringify(consentState));

    setDefaultConsentState(consentState);
    hasDefaultConsent = true;

    Log("data.fireCustomEvent", data.fireCustomEvent);

    if(data.fireCustomEvent){
      for (const key in consentState){
        if (queryPermission('access_consent', key, 'read')) {
          Log("Key: ", key);
          addConsentListener(key, function(consentType, granted) {
            Log("consentType: ", consentType);
            dataLayerPush({'event':  "Consent Changed: " + consentType, 'consent': granted, 'type': consentType});
          });
        }
      }
    }
  }
};

const onScriptInjectSucess = () => { Log("Successfully injected the CCM Script"); data.gtmOnSuccess(); };
const onScriptInjectError = () => { Log("Failed to injected the CCM Script"); data.gtmOnFailure(); };


// Script start
// ---------------------

Log("Data: " + JSON.stringify(data));
gtagSet({
  'developer_id.dNTIxZG': true,
  'ads_data_redaction': data.enableAdsRedacted,
  'url_passthrough': data.enableUrlPassthrough
});

let hasDefaultConsent = false;

//Inject CMP Code
Log("Deploy CMP Script: " + data.deployCmpScript);
if (data.deployCmpScript) {
  const cmID = data.cmpID;
  const additionalParameters = data.additionalParameters;
  const product = data.cmpType;
  const ccmScriptURLs = getCCMScriptUrl(cmID, product, additionalParameters);
  if (queryPermission('inject_script', hostName)){
    Log('permission granted to load JS');
    injectScript(ccmScriptURLs.ccm, onScriptInjectSucess, onScriptInjectError);
  } else {
    data.gtmOnFailure();
  }
}

//Integrate GCM
Log("Integrate with Google Consent Mode: " + data.integrateGCM);

if (data.integrateGCM) {
  defaultConsent(data.behaviorCookie);

  Log("Before call in window");

  callInWindow('addConsentListenerTA', function (prefCookie, behaviorCookie) {
    Log("Callback executed!!");
    if (hasGtagMapping()) {
      Log ("gtag mapping found. Skipping template consent update.");
      return;
    }
    if (!hasDefaultConsent) {
      defaultConsent(behaviorCookie);
    } else if (isDefined(prefCookie)) {
      var defaultGranted = behaviorCookie && defaultGranted(behaviorCookie);
      var cs = getConsentState(prefCookie, false, defaultGranted);
      updateConsentState(cs);

      Log("Updated consent state: " + JSON.stringify(cs));
      Log("Updated prefCookie: " + prefCookie);
      Log("Updated behaviorCookie: " + behaviorCookie);
    } else {
      Log("Invalid prefCookie: " + prefCookie);
    }
  });
} else {
  Log("Google Consent Mode Integration is Not Enabled");
}



// Script End
// ---------------------




// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "developer_id.dNTIxZG"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "addConsentListenerTA"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "truste.eu.bindMap.feat.gcm"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://consent.trustarc.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/18/2023, 4:42:43 PM


